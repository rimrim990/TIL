# 보충 자료

## TCP/IP 네트워크 스택 이해하기

`성공과 실패를 결정하는 1%의 네트워크 원리`를 읽으면서 학습했던 네트워크 스택을 다시 정리해보자.

### 네트워크 스택

네트워크 전송 과정은 여러 레이어에 의해 수행된다. 이는 크게 유저 영역과 커널 영역, 디바이스 영역으로 구분될 수 있다.
- 디바이스는 패킷을 송, 수신하는 NIC (Network Interface Card)를 의미한다

**데이터 전송으로 네트워크 스택 이해하기**

<img width="600" src="https://d2.naver.com/content/images/2015/06/helloworld-47667-1.png">

- 데이터 송신 과정을 살펴보면서 네트워크 스택에 대해 이해해보자
- 데이터를 전송하는 전체적인 과정은 위와 같다

**사용자 영역**
```
write(fd, buf, len)
```
- 애플리케이션 영역에서 유저가 `write` 시스템 콜을 호출하여 데이터 전송을 요청한다
  - 소켓은 이미 생성되어 있다고 가정
- 유저의 시스템 콜 호출로 인해 유저 모드에서 커널 모드로 전환된다


**커널 영역**

<img width="600" src="https://d2.naver.com/content/images/2015/06/helloworld-47667-6.png">

- 커널은 `write` 호출로 전달받은 소켓 디스크립터를 통해 TCP 연결 정보를 갖고 있는 소켓 구조체를 찾아간다
- 소켓 구조체에는 패킷 전송을 위한 `send socket buffer`와 `receive socket buffer`가 존재한다
  - 패킷 구조체인 `skb`를 리스트 형태로 관리
- 전송할 패킷을 소켓 구조체의 `send socket buffer`의 끝에 추가한다

<img width="600" src="http://www.ktword.co.kr/img_data/1889_1.jpg">

- 패킷을 `TCP 레이어`로 전송하고, 페이로드에 TCP 헤더를 추가한다

```
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.219.0   0.0.0.0         255.255.255.0   U     100    0        0 enp0s8
```
- 패킷을 `IP 레이어`로 전송하고, 페이로드에 IP 헤더를 추가한다
- 라우팅 테이블을 참조하여 최종 목적지 IP 전송하기 위한 다음 라우터의 IP 주소를 찾아낸다
- 예시에서 볼 수 있듯이, 라우팅 테이블을 참조하면 다음 라우터의 IP (`Gateway`) 뿐만 아니라 어떤 `NIC`로 (네트워크 인터페이스) 패킷을 전송해야 하는지도 알 수 있다

```
$ arp -a
? (239.255.255.250) at 1:0:5e:7f:ff:fa on en0 ifscope permanent [ethernet]
? (239.255.255.250) at 1:0:5e:7f:ff:fa on bridge100 ifscope permanent [ethernet]
```
- 또한 `IP 레이어`에서는 `ARP` 프로토콜을 사용하여 다음 라우터의 `MAC 주소`를 찾는다
- 이후 `Ethernet` 레이어를 지나고, 마지막으로 앞서 IP 라우팅으로 알게 된 `NIC`에 패킷 전송을 요청한다

**디바이스**
- 디바이스 영역인 `NIC`은 비트 형태의 디지털 데이터를 신호로 변환하여 연결된 링크로 송출하는 역할을 수행한다
- `NIC`은 패킷 송신과 수신을 비동기적으로 수행하고, 수행의 결과를 `CPU`에 인터럽트로 알려준다

<img width="600" src="https://d2.naver.com/content/images/2015/06/helloworld-47667-7.png">

- 디바이스 드라이버는 메모리 상에 패킷 구조체를 생성하고, 해당 메모리 영역을 가리키는 디스크립터를 만들어 이를 `TX ring`에 추가한다
  - 링은 디바이스 드라이버 영역에 존재하는 메모리 영역으로, `NIC`과 디바이스 드라이버가 패킷의 메모리 정보를 교환하기 위해 사용
- 디바이스 드라이버는 `NIC`에 디스크립터가 추가되었음을 알려준다
- `NIC`은 `DMA`를 수행하여 메모리 영역에서 직접 패킷 디스크립터와 패킷 정보를 가져온 후, 패킷을 전송한다
- 이후 패킷 전송이 완료되면 인터럽트 컨트롤러를 통해 `CPU`에 인터럽트 신호를 전송한다

**인터럽트의 종류**

앞서 `NIC`이 인터럽트 신호를 전달하고 했는데, 사실 인터럽트에는 두 가지 종류가 존재한다

<img width="600" src="https://github.com/rimrim990/test-repository/assets/62409503/0b64a0ae-18a6-407e-b294-8666773d446b">

- 인터럽터는 하드웨어에 의해 발생해 인터럽트 컨트롤러를 거쳐 CPU 에 전달되는 하드웨어 인터럽트가 존재한다. 또한 CPU 에서 명령어 실행에 의해 발생하는 소프트웨어 인터럽트가 존재한다
- 하드웨어 인터럽트와 다르게 소프트웨어 인터럽트는 즉시 실행되지 않으며, 하드웨어 인터럽트에 의해 인터럽트 될 수 있다

<img width="600" src="https://github.com/rimrim990/test-repository/assets/62409503/1b31026a-c52e-4b55-b659-837a1aa2808e">

- 소프트웨어 인터럽트는 위와 같이 정해져있다
- 하드웨어와 소프트웨어 인터럽트를 나눔으로써 인터럽트가 발생했을 때 커널이 너무 많은 일을 수행할 필요가 없어진다
- 예를 들어 패킷을 수신받은 후 `NIC`이 하드웨어 인터럽트를 발생시키면, 커널은 패킷을 메모리에 옮겨고 드라이버 링에 디스크립터를 추가하기만 하면 된다. 이후의 일들은 소프트웨어 인터럽트 핸들러 잡을 큐에 추가하여, 일단 나중으로 미뤄놓는다.

### 출처
- COSE322-00, Operating Systems Lab, Korea Univ.
- https://d2.naver.com/helloworld/47667 (TCP/IP 네트워크 스택 이해하기)