# TIL - 2023.09.28(ëª©)

ğŸ›« í•´ì™¸ì—¬í–‰ ê°€ê³  ì‹¶ë‹¤ !! ğŸ‘Š

## JDBC ì™€ DataSource

### JDBC
JDBC ëŠ” ìë°”ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ì„ ìœ„í•´ ì œê³µí•˜ëŠ” ë¡œìš°ë ˆë²¨ API ì´ë‹¤
- ë°ì´í„°ë² ì´ìŠ¤ì— ì¿¼ë¦¬ë¥¼ ë³´ë‚´ê³  ë°ì´í„°ë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ìˆëŠ” ë°©ë²• ì œê³µ
- DBMS ì¢…ë¥˜ì— ìƒê´€ì—†ì´ **ì¼ê´€ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µ**
- DB ë²¤ë”ëŠ” **JDBC í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ ë“œë¼ì´ë²„ë¥¼ ì œê³µ**
- JDBC ë¡œ ê°œë°œí•œ ì½”ë“œëŠ” DB ê°€ ë³€ê²½ë˜ì–´ë„ ê·¸ëŒ€ë¡œ ì¬í™œìš© ê°€ëŠ¥
- í•˜ì´ë²„ë„¤ì´íŠ¸ì™€ ê°™ì€ ORM ê¸°ìˆ ë¡œ ë‚´ë¶€ì ìœ¼ë¡œëŠ” DB ì—°ë™ì„ ìœ„í•´ JDBC ë¥¼ ì‚¬ìš©

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FIS7Q7%2FbtrR4G2GJPN%2FU3k0zntzKSMYLO3HJC8431%2Fimg.png">

**JDBC ë™ì‘ íë¦„**
- JDBC ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ì¸ ë“œë¼ì´ë²„ë¥¼ ë¡œë”©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°í•œë‹¤ (DriverManager ì—ì„œ ìë™ ë¡œë”©)
- JDBC API ëŠ” DriverManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ë“œë¼ì´ë²„ë“¤ì„ ê´€ë¦¬í•˜ê³  ì ì ˆí•œ ë²¤ë”ì˜ ë“œë¼ì´ë²„ë¡œë¶€í„° DB Connection ì„ ìƒì„±í•´ì¤€ë‹¤
- Connection ì€ ë°ì´í„°ë² ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš© í•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì ‘ê·¼í•˜ë©°, ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ì‘ìš©ì€ Connection ì„ í†µí•´ ì´ë¤„ì ¸ì•¼ í•œë‹¤ 

```java
connection = DriverManager.getConnection(url, username, password);
```
- ì‚¬ìš©ìëŠ” JDBC ì—ì„œ ì œê³µí•˜ëŠ” `DriverManager`ë¥¼ í˜¸ì¶œí•˜ì—¬ í¸ë¦¬í•˜ê²Œ DB ì»¤ë„¥ì…˜ì„ ì–»ì–´ì˜¬ ìˆ˜ ìˆë‹¤
  - `DriverManager`ê°€ ì‚¬ìš©ì ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì ì ˆí•œ DB ë“œë¼ì´ë²„ì— ì—°ê²°

<img src="https://www.tutorialspoint.com/jdbc/images/jdbc_architecture.jpg">

### DataSource
**DriverManager**
- JDBC ì—ì„œ ì œê³µí•˜ëŠ” `DriverManager`ë¥¼ ì‚¬ìš©í•˜ë©´ ë§¤ë²ˆ DB ì»¤ë„¥ì…˜ì„ ì–»ê³  ì‚¬ìš©ì´ ì™„ë£Œëœ í›„ ì»¤ë„¥ì…˜ì„ ë°˜í™˜í•œë‹¤
  - ë§¤ë²ˆ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ëŠ” ê²ƒì€ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ì´ ë“¤ê³  ë¹„íš¨ìœ¨ì 
  - SQL ì„ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ì»¤ë„¥ì…˜ì„ ìƒì„±í•´ì•¼ í•¨

```java
// H2 ë“œë¼ì´ë²„
public class Driver implements java.sql.Driver, JdbcDriverBackwardsCompat {
    // ì• í”Œì¼€ì´ì…˜ì—ì„œ ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€! DriverManager.Connection ì„ í†µí•´ í˜¸ì¶œí•  ê²ƒ.
  @Override
  public Connection connect(String url, Properties info) throws SQLException {
    if (url == null) {
      throw DbException.getJdbcSQLException(ErrorCode.URL_FORMAT_ERROR_2, null, Constants.URL_FORMAT, null);
    } else if (url.startsWith(Constants.START_URL)) {
      return new JdbcConnection(url, info, null, null, false);
    } else if (url.equals(DEFAULT_URL)) {
      return DEFAULT_CONNECTION.get();
    } else {
      return null;
    }
  }
}
```

**ì»¤ë„¥ì…˜ í’€**
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ í•„ìš”í•  ë•Œë§ˆë‹¤ ë§¤ë²ˆ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šê³  ë¯¸ë¦¬ ìƒì„±í•´ë†“ì€ ì»¤ë„¥ì…˜ í’€ì—ì„œ ì»¤ë„¥ì…˜ì„ ë°›ì•„ê°„ë‹¤
  - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ í•„ìš”ì—†ì–´ì§€ë©´ ë‹¤ì‹œ ì»¤ë„¥ì…˜ í’€ì— ë°˜í™˜
  - ì»¤ë„¥ì…˜ì„ ì¬ì‚¬ìš©í•˜ì—¬ ë¦¬ì†ŒìŠ¤ ì‚¬ìš© íš¨ìœ¨ì„ ë†’ì„

**DataSource**
- ìë°”ì—ì„œëŠ” ì–´ë–»ê²Œ ì»¤ë„¥ì…˜ì„ ì–»ë“  ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì»¤ë„¥ì…˜ì„ ì–»ì„ ìˆ˜ ìˆë„ë¡ `DataSource` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•œë‹¤
  - `DataSource`ëŠ” `DriverManager`ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ ì–»ëŠ” ë°©ë²•ì˜ ë” ê°„ë‹¨í•œ ëŒ€ì²´ì¬
  - ì»¤ë„¥ì…˜ í’€ì„ ì œê³µí•˜ëŠ” `DataSource` êµ¬í˜„ì²´ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ í’€ë§ ê°€ëŠ¥
  - DB ë²¤ë” ì‚¬ì—ì„œ ìì²´ `DataSource` ë¥¼ ì œê³µ
- ìŠ¤í”„ë§ì—ì„œëŠ” `DriverManager`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§¤ë²ˆ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ëŠ” `DriverManagerDataSource` ë¥¼ ì œê³µí•œë‹¤
- ìŠ¤í”„ë§ì—ì„œëŠ” ì»¤ë„¥ì…˜ì„ ì–»ê¸° ìœ„í•œ ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ `HikariCP` ì»¤ë„¥ì…˜ í’€ì„ ê¸°ë°˜ìœ¼ë¡œ `HikariDataSource` ë¥¼ ì‚¬ìš©í•œë‹¤

```java
// MySQL ì—ì„œ ì œê³µí•˜ëŠ” ë°ì´í„°ì†ŒìŠ¤
public class MysqlDataSource extends JdbcPropertySetImpl implements DataSource, Referenceable, Serializable, JdbcPropertySet {
    
    // ë””ë¹„ ì—°ê²°ì„ ìœ„í•´ ë“œë¼ì´ë²„ ì‚¬ìš©
  protected final static NonRegisteringDriver mysqlDriver;

  // ë””ë¹„ ì—°ê²°ì„ ìœ„í•œ ê³µí†µëœ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
  protected java.sql.Connection getConnection(Properties props) throws SQLException {
    String jdbcUrlToUse = this.explicitUrl ? this.url : getUrl();
    // ...
    return mysqlDriver.connect(jdbcUrlToUse, props);
  }
}
```

**ìŠ¤í”„ë§ ë¶€íŠ¸ HikariDataSource**
```java
// beanName: "dataSource"
public HikariDataSource()
{
    super();
    fastPathPool = null;
}
```
- ìŠ¤í”„ë§ ë¶€íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì— `HikariDataSource`ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤

```java
@Bean
@ConfigurationProperties(prefix = "spring.datasource.hikari")
HikariDataSource dataSource(DataSourceProperties properties, JdbcConnectionDetails connectionDetails) {
    HikariDataSource dataSource = createDataSource(connectionDetails, HikariDataSource.class, properties.getClassLoader());
    if (StringUtils.hasText(properties.getName())) {
        dataSource.setPoolName(properties.getName());
    }
    return dataSource;
}
```
- ìŠ¤í”„ë§ ë¶€íŠ¸ JDBC `DataSourceConfiguration`ì— `HikariDataSource`ê°€ ë°ì´í„° ì†ŒìŠ¤ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆë‹¤

### ì°¸ê³ ìë£Œ
- https://tecoble.techcourse.co.kr/post/2022-11-07-transaction-aop-fact-and-misconception/