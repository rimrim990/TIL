# TIL - 2023.09.12 (í™”)
## ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ 

ìš°í…Œìº ì´ ëë‚˜ë©´ í•˜ê³  ì‹¶ì—ˆë˜ ê³µë¶€ë¥¼ ë§ì´ í•  ìˆ˜ ìˆì„ ê±°ë¼ ê¸°ëŒ€í–ˆëŠ”ë° ì„œë¥˜ë‚˜ ë©´ì ‘ ì¤€ë¹„ ë•Œë¬¸ì— ê³„ì† ë°€ë¦¬ê³  ìˆë‹¤ ğŸ˜¢

ì´í™í‹°ë¸Œ ìë°”ë‘ RealMySQL ë„ ì–¸ë„ ì½ê³  TIL ë„ ì§„ë“í•˜ê²Œ ì‘ì„±í•˜ê³  ì‹¶ë‹¤...

### ì„œë¬¸
ì´ì „ íŒ€ í”„ë¡œì íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ ê°„ í™˜ê²½ ê²©ë¦¬ë¥¼ ìœ„í•´ ê° ë©”ì„œë“œ ì‹¤í–‰ ì „ì— `TestExecutionListener`ë¡œ `Truncate` SQL ì„ ì‹¤í–‰í•˜ì˜€ë‹¤.

ê·¸ëŸ°ë° `TestExecutionListener`ê°€ ëŒ€ì¶© ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ ì ì ˆí•œ ë•Œì— ì •ì˜ëœ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤ ì •ë„ë§Œ ì•Œê³  ë„˜ì–´ê°€ì„œ, ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ëŠ” ìì„¸íˆ ëª¨ë¥¸ë‹¤.

ë”°ë¼ì„œ ì˜¤ëŠ˜ì€ ì´ì— ëŒ€í•´ ì•Œì•„ë³´ê³ ì í•œë‹¤!

### TestExecutionListener
```
TestExecutionListener defines a listener API for reacting to test execution events 
published by the TestContextManager with which the listener is registered.```
```
- `TestExecutionListener`ëŠ” `TestContextManager`ê°€ ë°œí–‰í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ê³  ì´ì— ë°˜ì‘í•˜ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì •ì˜í•œë‹¤

ìë°” ë¬¸ì„œì— ë‚˜ì™€ì•˜ëŠ” ì„¤ëª…ì¸ë°, ì´ê²ƒë§Œìœ¼ë¡œëŠ” ì–´ë–¤ ì˜ë¯¸ì¸ì§€ ì˜ ëª¨ë¥´ê² ë‹¤. 

**ì¸í„°í˜ì´ìŠ¤ ì‚´í´ë³´ê¸°**
```java
public interface TestExecutionListener {
    default void beforeTestClass(TestContext testContext) throws Exception {};
    default void prepareTestInstance(TestContext testContext) throws Exception {};
    default void beforeTestMethod(TestContext testContext) throws Exception {};
    default void beforeTestExecution(TestContext testContext) throws Exception {};
    default void afterTestExecution(TestContext testContext) throws Exception {};
    default void afterTestMethod(TestContext testContext) throws Exception {};
    default void afterTestClass(TestContext testContext) throws Exception {};
}
```
- êµ¬í˜„ì´ ë¹„ì–´ìˆëŠ” ì—¬ëŸ¬ ê°œì˜ `default` ë©”ì„œë“œê°€ ì •ì˜ë˜ì–´ ìˆë‹¤
  - ë”°ë¼ì„œ í•„ìš”í•œ ë©”ì„œë“œë§Œ êµ¬í˜„í•˜ë©´ ë¨
- `TestContext`ì˜ ì‹¤í–‰ ë‹¨ê³„ë§ˆë‹¤ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ ì´ì— ë§ëŠ” ë©”ì„œë“œë¥¼ ì‹¤í–‰í•œë‹¤
  - `beforeTestClass` - í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ì‹¤í–‰
  - `prepareTestInstance` - í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ëœ ì§í›„ ì‹¤í–‰
  - `beforeTestMethod` - í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì˜ `before` ìƒëª…ì£¼ê¸° ì½œë°± ì§ì „ ì‹¤í–‰
  - `beforeTestExecution` - í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ì˜ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ ì‹¤í–‰ ì§ì „ ì‹¤í–‰
  - `afterTestExecution` - í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ì˜ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ ì‹¤í–‰ ì§í›„ ì‹¤í–‰
  - `afterTestMethod` - í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì˜ `after` ìƒëª…ì£¼ê¸° ì½œë°± ì§í›„ ì‹¤í–‰
  - `afterTestClass` - í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì˜ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œê°€ ì „ë¶€ ì‹¤í–‰ëœ ì§í›„ ì‹¤í–‰

### ìŠ¤í”„ë§ ê¸°ë³¸ TestExecutionListener
ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì—ì„œëŠ” ì—¬ëŸ¬ ê°œì˜ ê¸°ë³¸ `TestExecutionListener` ë“¤ì„ ì œê³µí•œë‹¤
- `DirtiesContextBeforeModesTestExecutionListener` - `@DirtiesContext` ì• ë„ˆí…Œì´ì…˜ì˜ `before` ëª¨ë“œë¥¼ ì²˜ë¦¬
- `DirtiesContextTestExecutionListener` - `@DirtiesContext` ì• ë„ˆí…Œì´ì…˜ì˜ `after` ëª¨ë“œë¥¼ ì²˜ë¦¬
- `TransactionalTestExecutionListener` - ê¸°ë³¸ ë¡¤ë°± ì„¤ì •ê³¼ í•¨ê»˜ íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ì œê³µ
- `SqlScriptsTestExecutionListener` - `@SQL` ì• ë„ˆí…Œì´ì…˜ì— ì„¤ì •ëœ `SQL` ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

**TransactionalTestExecutionListener**
```java
@Override
	public void beforeTestMethod(final TestContext testContext) throws Exception {
		Method testMethod = testContext.getTestMethod();
		Class<?> testClass = testContext.getTestClass();

		TransactionContext txContext = TransactionContextHolder.removeCurrentTransactionContext();
		PlatformTransactionManager tm = null;
		TransactionAttribute transactionAttribute = this.attributeSource.getTransactionAttribute(testMethod, testClass);

		if (transactionAttribute != null) {
            // @BeforeTransaction ë©”ì„œë“œ ì‹¤í–‰
        }

		if (tm != null) {
            // íŠ¸ë˜ì­ì…˜ ì‹¤í–‰
			txContext = new TransactionContext(testContext, tm, transactionAttribute, isRollback(testContext));
			txContext.startTransaction();
		}
	}
```
- íŠ¸ëœì­ì…˜ì´ ì„¤ì •ëœ ë©”ì„œë“œì— ëŒ€í•´ ì‹¤í–‰ëœë‹¤

```java
protected final boolean isRollback(TestContext testContext) throws Exception {
    boolean rollback = isDefaultRollback(testContext); // ê¸°ë³¸ ê°’ true
    Method testMethod = testContext.getTestMethod();
    Rollback rollbackAnnotation = AnnotatedElementUtils.findMergedAnnotation(testMethod, Rollback.class);
    // ...
    return rollback;
}
```
- íŠ¸ëœì­ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤í„°ì—ì„œëŠ” ëª…ì‹œì ì¸ `@Rollback` ì„¤ì •ì´ ì—†ìœ¼ë©´ `rollback`ì˜ ê¸°ë³¸ ê°’ì„ `true`ë¡œ ì„¤ì •í•œë‹¤
- ê·¸ë ‡ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ `@Transaction`ì„ ì„¤ì •í•˜ë©´ í•­ìƒ ë¡¤ë°±ë˜ëŠ” ê²ƒì´ë‹¤

**SqlScriptsTestExecutionListener**
```java
private void executeSqlScripts(TestContext testContext, ExecutionPhase executionPhase) {
    Method testMethod = testContext.getTestMethod();
    Class<?> testClass = testContext.getTestClass();

    if (mergeSqlAnnotations(testContext)) {
        executeSqlScripts(getSqlAnnotationsFor(testClass), testContext, executionPhase, true);
        executeSqlScripts(getSqlAnnotationsFor(testMethod), testContext, executionPhase, false);
    }
    
    else {
        // ...
    }
}

// executeSqlScripts
sqlAnnotations.forEach(sql -> executeSqlScripts(sql, executionPhase, testContext, classLevel));
```
- `@SQL`ì• ë„ˆí…Œì´ì…˜ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤

ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ë¥¼ ì‹¤í–‰í•˜ë©´ ì‹¤í–‰ ìƒíƒœë§ˆë‹¤ ì ì ˆí•œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œ í…ŒìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚´ì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´, ìŠ¤í”„ë§ì—ì„œëŠ” ì–´ë–»ê²Œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³  ì´ë¥¼ ê°ì§€í•˜ëŠ” ê±¸ê¹Œ?

### TestContextManager
```java
public void beforeTestClass() throws Exception {
    Class<?> testClass = getTestContext().getTestClass();
    getTestContext().updateState(null, null, null);

    for (TestExecutionListener testExecutionListener : getTestExecutionListeners()) {
        try {
            testExecutionListener.beforeTestClass(getTestContext());
        }
        catch (Throwable ex) {  
            // ...
        }
    }
}
```
- í…ŒìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ê²ƒì€ `TestContextManager` ì˜€ë‹¤
- ì˜ˆì‹œë¡œ ê°€ì ¸ì˜¨ `beforeTestMethod`ëŠ” í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì˜ ë©”ì„œë“œê°€ í˜¸ì¶œì´ ì‹œì‘ë˜ê¸° ì „ì— ì „ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‹¤í–‰ëœë‹¤
  - ìë°” ë…ì— ì˜í•˜ë©´ `TestContextManager`ì˜ `beforeTestClass` ëŠ” `@BeforeAll` ê³¼ ê°™ì€ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ ë©”ì„œë“œ ì´ì „ì— ì‹¤í–‰ë¨
- í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ë‹¤ê³  í•˜ê¸¸ë˜ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë°©ì‹ì¸ê°€ ì‹¶ì—ˆëŠ”ë°, ê·¸ëƒ¥ ì •ì§í•˜ê²Œ ìˆœì°¨ì ìœ¼ë¡œ í˜¸ì¶œí•´ì„œ ë‹¹í™©ìŠ¤ëŸ½ë‹¤
  - ì°¾ì•„ë³´ë‹ˆ ìŠ¤í”„ë§ ì´ë²¤íŠ¸ëŠ” ìŠ¤í”„ë§ ë¹ˆ ì‚¬ì´ì— ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜ë©°, ì„œë¹„ìŠ¤ ê°•ì˜ ê°•í•œ ê²°í•©ì„ ì¤„ì´ëŠ”ê²Œ ëª©ì ì´ë¼ê³  í•¨
  - DIë¡œ ì˜ì¡´ì„±ì„ ì£¼ì…ë°›ëŠ” ëŒ€ì‹  ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ëŠ” ì‹ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ë“¯

### @TestExecutionListener ì‚¬ìš©í•˜ê¸°
```
@ActiveProfiles("test")
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Retention(RetentionPolicy.RUNTIME)
@TestExecutionListeners(value = {IntegrationTestExecutionListener.class,}, mergeMode = TestExecutionListeners.MergeMode.MERGE_WITH_DEFAULTS)
public @interface IntegrationTest {
}
```
- íŒ€ í”„ë¡œì íŠ¸ì—ì„œëŠ” ìœ„ì™€ ê°™ì´ ì‚¬ìš©í–ˆì—ˆë‹¤
- `mergeMode` ì†ì„±ì´ ì¤‘ë³µë˜ëŠ” ì†ì„±ì„ ì²˜ë¦¬í•˜ëŠ” ì„¤ì •ì¸ì¤„ ì•Œì•˜ëŠ”ë° ì•„ë‹ˆì—ˆë‹¤..
- ìˆ˜ë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•˜ë©´ ìŠ¤í”„ë§ì—ì„œ ê¸°ë³¸ ì„¤ì •í•œ í…ŒìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤
  - ì´ë•Œ `mergeMode`ë¥¼ ì„¤ì •í•˜ë©´ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆì™€ ì»¤ìŠ¤í…€ ë¦¬ìŠ¤ë„ˆë¥¼ í•¨ê»˜ ë™ì‘ì‹œí‚¬ ìˆ˜ ìˆìŒ!
  - ì¤‘ë³µëœ ë¦¬ìŠ¤ë„ˆëŠ” ì§€ìš°ê³  ë¦¬ìŠ¤ë„ˆë“¤ ê°„ì— ì ì ˆí•˜ê²Œ ìˆœì„œë„ ë°°ì¹˜í•´ì¤€ë‹¤ê³  í•¨







