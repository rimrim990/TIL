# TIL - 2023.09.10 (ì¼)
## ìŠ¤í”„ë§ ê¸°ë³¸í‚¤ ìƒì„± ì „ëµ

### ì„œë¬¸
ìŠ¤í”„ë§ ë°ì´í„° JPA ë¥¼ ì‚¬ìš©í•  ë•Œ ê¸°ë³¸í‚¤ ìƒì„± ì „ëµì—ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì´ ì¡´ì¬í–ˆë‹¤.

ê° ìƒì„± ì „ëµì´ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.

### ê¸°ë³¸í‚¤ ìƒì„± ì „ëµ
ìŠ¤í”„ë§ ë°ì´í„° JPA ì—ì„œ `@GeneratedValue`ë¡œ ê¸°ë³¸í‚¤ ìë™ ìƒì„±ì„ ì„¤ì •í•œë‹¤ë©´ ê¸°ë³¸í‚¤ ìƒì„± ì „ëµì„ ì„ ì •í•´ì•¼ í•œë‹¤.
ê¸°ë³¸ ì„¤ì •ì€ `AUTO`ì´ë‹¤

ìŠ¤í”„ë§ ë°ì´í„° JPA ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ë³¸í‚¤ ìƒì„± ì „ëµì€ ë‹¤ìŒê³¼ ê°™ë‹¤
- `AUTO`
- `IDENTITY`
- `SEQUENACE`
- `TABLE`

### AUTO
ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸ì— ë”°ë¼ í‚¤ ìƒì„± ì „ëµì„ ì„¤ì •í•œë‹¤

### IDENTITY
**í…Œì´ë¸” ìƒì„±**

- `IDENTITY` ì „ëµì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ìë™ ì¦ê°€ ì»¬ëŸ¼ì— ìœ„ì„í•˜ì—¬ í‚¤ ê°’ì„ ìƒì„±í•œë‹¤
```
// h2
Hibernate: create table identity_member (id bigint generated by default as identity, primary key (id))
```

**INSERT**
- `IDENTITY`ë°©ì‹ìœ¼ë¡œ ì„¤ì •ëœ ê²½ìš° `persist`ë¥¼ ìˆ˜í–‰í•œ ì¦‰ì‹œ `INSERT` ì¿¼ë¦¬ë¥¼ ì „ì†¡í•˜ë©° ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤
  - DBMS ì—ì„œ í‚¤ ê°’ì„ ìƒì„±í•˜ê¸° ë•Œë¬¸ì—, `INSERT`ê°€ ìˆ˜í–‰ë˜ì–´ì•¼ ì—”í‹°í‹°ì˜ í‚¤ ê°’ì„ ì•Œ ìˆ˜ ìˆìŒ
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” í‚¤ ê°’ìœ¼ë¡œ ì—”í‹°í‹°ë¥¼ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì—, ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ë©´ ë°˜ë“œì‹œ í‚¤ ê°’ì´ í• ë‹¹ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤
```
----INSERT----
Hibernate: insert into identity_member (id) values (default)
----SELECT----
```
- `persist`ë¥¼ í˜¸ì¶œí•œ ì¦‰ì‹œ ì¿¼ë¦¬ë¥¼ ì „ì†¡í–ˆë‹¤
  - `INSERT`ì¿¼ë¦¬ë¥¼ ì „ì†¡í•œ í›„ì— `SELECT`ë¥¼ ìˆ˜í–‰í–ˆë‹¤

### SEQUENCE
**í…Œì´ë¸” ìƒì„±**

- `SEQUENCE` ì „ëµì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì‹œí€€ìŠ¤ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í‚¤ ê°’ì„ ìƒì„±í•œë‹¤
```
// h2
Hibernate: create sequence sequence_member_seq start with 1 increment by 50
Hibernate: create table sequence_member (id bigint not null, primary key (id))
```
- ì‹œí€€ìŠ¤ ì „ëµì´ ì ìš©ëœ í…Œì´ë¸” ìƒì„± ì‹œ ì‹œí€€ìŠ¤ ì˜¤ë¸Œì íŠ¸ë¥¼ í•¨ê»˜ ìƒì„±í•œë‹¤
  - ì‹œí€€ìŠ¤ ê°’ì€ 1ë¶€í„° ì‹œì‘í•œë‹¤

**INSERT**

```java
Hibernate: select next value for sequence_member_seq
Hibernate: insert into sequence_member (id) values (?)
```
- DBì— ì¿¼ë¦¬ë¥¼ ë³´ë‚´ í…Œì´ë¸”ì— ì‚¬ìš©í•  ì‹œí€€ìŠ¤ ê°’ì„ ë¨¼ì € ê°€ì ¸ì˜¨ë‹¤
- ê°€ì ¸ì˜¨ ì‹œí€€ìŠ¤ ê°’ì„ ê¸°ë³¸ í‚¤ë¡œ ì„¤ì •í•˜ì—¬ `INSERT`ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•œë‹¤

**allocationSize**
- ì‹œí€€ìŠ¤ ì „ëµì„ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ë¡œë¶€í„° í‚¤ ê°’ì„ ë¯¸ë¦¬ ê°€ì ¸ì™€ì•„í•œë‹¤
  - ì•„ì´ë´í‹°í‹° ì „ëµê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œ ë¯¸ë¦¬ ì¿¼ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
  - ë”°ë¼ì„œ `flush`ê°€ ìˆ˜í–‰ë˜ê¸° ì „ì— ë¯¸ë¦¬ `SELECT` ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ í‚¤ ê°’ ê°€ì ¸ì˜´
- ê·¸ëŸ¬ë‚˜ ë§¤ë²ˆ ì—”í‹°í‹°ë¥¼ ì˜ì†í™”í•˜ê¸° ìœ„í•´ ì‹œí€€ìŠ¤ `SELECT` ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆë‹¤
  - ë§¤ë²ˆ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì¿¼ë¦¬ ì „ì†¡
- ë”°ë¼ì„œ `allocationSize` ì„¤ì •ì„ í†µí•´ ì‹œí€€ìŠ¤ ê°’ì„ í•œ ë²ˆì— ì—¬ëŸ¬ ê°œì”© ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤
  - ê¸°ë³¸ ê°’ì€ 50

```java
@Entity
public class SequenceMember {

    @Id
    @SequenceGenerator(name = "member_seq", allocationSize = 10)
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    private Long id;
}
```
- 50ê°œì˜ ì‹œí€€ìŠ¤ë¥¼ ë¯¸ë¦¬ í• ë‹¹í•´ ë©”ëª¨ë¦¬ì— ê°€ì ¸ì˜¨ í›„, í•˜ë‚˜ì”© ì‚¬ìš©í•œë‹¤
- ë°ì´í„°ë² ì´ìŠ¤ ì‹œí€€ìŠ¤ëŠ” 51ë¡œ ì„¤ì •ëœë‹¤

```java
Hibernate: select next value for sequence_member_seq
----FIRST PERSISTED-----
Hibernate: select next value for sequence_member_seq

----SECOND PERSISTED CALLED-----
----THIRD PERSISTED CALLED-----
----FOURTH PERSISTED CALLED-----
Hibernate: insert into sequence_member (id) values (?)
Hibernate: insert into sequence_member (id) values (?)
Hibernate: insert into sequence_member (id) values (?)
Hibernate: insert into sequence_member (id) values (?)
```
- ì²˜ìŒì— ë³´ë‚¸ ìš”ì²­ì€ ì‹œí€€ìŠ¤ ê°’ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ `INSERT`ê°€ í˜¸ì¶œë˜ìë§ˆì `SELECT`ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•œë‹¤
- ë¯¸ë¦¬ ì—¬ëŸ¬ ê°œì˜ ì‹œí€€ìŠ¤ ê°’ì„ ê°€ì ¸ì™”ê¸° ë•Œë¬¸ì— ì´í›„ì˜ `persist`ìš”ì²­ë“¤ì€ ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ì‹œí€€ìŠ¤ ê°’ì„ ì‚¬ìš©í•œë‹¤
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ `flush` ë  ë•Œ ì“°ê¸° ì§€ì—°ìœ¼ë¡œ `INSERT` ì¿¼ë¦¬ë“¤ì„ ì „ì†¡í•œë‹¤

```java
Hibernate: insert into sequence_member (id) values (?) // 51
Hibernate: insert into sequence_member (id) values (?) // 101
Hibernate: insert into sequence_member (id) values (?) // 151
```
- ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹œí€€ìŠ¤ ê°’ì„ ì¡°íšŒí•´ë³´ì•˜ë‹¤
- ì¡°íšŒ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë  ë•Œë§ˆë‹¤ ì‹œí€€ìŠ¤ ì˜¤ë¸Œì íŠ¸ì˜ ê°’ì´ ê¸°ë³¸ ì„¤ì •ì¸ 50ì”© ì¦ê°€í•œë‹¤
- ë©”ëª¨ë¦¬ì— ì‹œí€€ìŠ¤ ê°’ì„ ë¯¸ë¦¬ ê°€ì ¸ì˜¨ ìƒíƒœì—ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë‚´ë ¤ ë©”ëª¨ë¦¬ê°€ ë‚ ë¼ê°„ë‹¤ë©´, ì‹œí€€ìŠ¤ì— êµ¬ë©ì´ ìƒê¸¸ ìˆ˜ ìˆë‹¤

### Table
**í…Œì´ë¸” ìƒì„±**
- í‚¤ ìƒì„±ì„ ìœ„í•œ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ ì‹œí€€ìŠ¤ ì „ëµì²˜ëŸ¼ ì‚¬ìš©í•œë‹¤
```java
Hibernate: create table hibernate_sequences (next_val bigint, sequence_name varchar(255) not null, primary key (sequence_name))
Hibernate: insert into hibernate_sequences(sequence_name, next_val) values ('default',0)
Hibernate: create table table_member (id bigint not null, primary key (id))
```
- ì‹œí€€ìŠ¤ ì „ëµì—ì„œëŠ” ì—”í‹°í‹° ì „ìš© ì‹œí€€ìŠ¤ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ, í…Œì´ë¸” ì „ëµì—ì„œëŠ” ëª¨ë“  í…Œì´ë¸”ì´ ê³µìœ í•˜ëŠ” í‚¤ í…Œì´ë¸”ì„ ìƒì„±í•œë‹¤
  - ì—”í‹°í‹° í…Œì´ë¸” ì´ë¦„ì„ pkë¡œ í•˜ì—¬ êµ¬ë¶„

**INSERT**
```java
Hibernate: select tbl.next_val from hibernate_sequences tbl where tbl.sequence_name=? for update
Hibernate: update hibernate_sequences set next_val=?  where next_val=? and sequence_name=?
Hibernate: insert into table_member (id) values (?)
```
- ì‹œí€€ìŠ¤ ì˜¤ë¸Œì íŠ¸ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ë¯¸ë¦¬ í‚¤ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤
  - í…Œì´ë¸”ì— ì €ì¥ëœ í‚¤ ê°’ì„ ê°±ì‹ í•˜ê¸° ìœ„í•´ ì“°ê¸° ë½ ê±º

**allocationSize**
```java
Hibernate: select tbl.next_val from hibernate_sequences tbl where tbl.sequence_name=? for update
Hibernate: update hibernate_sequences set next_val=?  where next_val=? and sequence_name=?
----FIRST PERSISTED CALLED-----
Hibernate: select tbl.next_val from hibernate_sequences tbl where tbl.sequence_name=? for update
Hibernate: update hibernate_sequences set next_val=?  where next_val=? and sequence_name=?
        
Hibernate: insert into table_member (id) values (?)
Hibernate: insert into table_member (id) values (?)
----SECOND PERSISTED CALLED-----
----THIRD PERSISTED CALLED-----
----FOURTH PERSISTED CALLED-----
Hibernate: insert into table_member (id) values (?)
Hibernate: insert into table_member (id) values (?)
```
- ì‹œí€€ìŠ¤ ì˜¤ë¸Œì íŠ¸ì™€ ë§ˆì°¬ê°€ì§€ë¡œ `allocationValue`ë¥¼ ì„¤ì •í•˜ì—¬ í•œ ë²ˆì— ì—¬ëŸ¬ ê°œì˜ ê°’ì”© ì—…ë°ì´íŠ¸í•˜ë„ë¡ ìµœì í™”í•˜ì˜€ë‹¤
- ì²˜ìŒ ì „ì†¡ëœ ì¿¼ë¦¬ë¡œ í‚¤ ê°’ì„ ì´ˆê¸°í™”í•˜ê³ , ë‘ ë²ˆì§¸ ë³´ë‚´ì§„ ì¿¼ë¦¬ë¡œ ê°’ì„ 50 ì¦ê°€ì‹œí‚¨ë‹¤
  - `SELECT`ë¡œ ì¡°íšŒ ì‹œ ë§ˆì§€ë§‰ìœ¼ë¡œ ì‚¬ìš©ëœ í‚¤ ê°’ì„ ì¡°íšŒ
- ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ì‹œí€€ìŠ¤ ì „ëµê³¼ í…Œì´ë¸” ì „ëµì—ì„œ `SELECT`ì¿¼ë¦¬ê°€ ë‘ ë²ˆ í˜¸ì¶œë˜ê³  ìˆë‹¤.. ğŸ¥¸
  - ì™œì¼ê¹Œ..