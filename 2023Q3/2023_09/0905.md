# TIL - 2023.09.05 (화)
## DB 커넥션 풀 (1)

### 서문
다른 개발자들과 DB 커넥션 풀이 전부 사용 중인 상태에서 새로운 커넥션 요청이 오면 어떻게 되는지 이야기를 나누었다.
커넥션 풀에 저장된 커넥션이 전부 사용 중이면 뒤이어 들어온 커넥션 요청은 커넥션이 반환될 때까지 기다려야 할 것이다.
실제로도 커넥션 풀 크기 이상의 요청이 왔을 때 이렇게 동작할까 ?

스프링에서 사용하는 기본 커넥션 풀인 `HikariCP` 를 기준으로 데이터베이스 커넥션 풀의 동작을 살펴보도록 하겠다.

### 커넥션 풀
커넥션 풀은 **데이터베이스 커넥션을 캐싱**한 구현체라고 볼 수 있다
- 데이터베이스 커넥션을 얻는 것은 비용이 비싼 작업이다
- 따라서 WAS 가 실행될 때 일정량의 커넥션을 커넥션 풀에 미리 생성해놓은 후, 이것들을 **재사용** 한다
- 클라이언트로부터 요청이 오면 `Connection` 객체를 빌려주고, 작업이 종료되면 `Connection` 을 다시 커넥션 풀에 반환받는다

**커넥션 생성 비용이 비싼 이유**

`DBMS` 와 어플리케이션은 `TCP/IP` 방식으로 통신한다
- 네트워크 
  - 양방향 연결 생성을 위해 `3-way handshake`  
  - 연결을 종료하기 위해 `4-way handshake` 
- DBMS 
  - 쿼리를 수행하기 위해 `DBMS` 에서 스레드 혹은 프로세스를 생성해야 함
  - 동시접속이 늘어나면 프로세스 혹은 스레드 생성으로 인한 시간 지연 발생할 수 있음

커넥션 풀을 사용하는 이유는 **커넥션 생성에 의한 비용을 감소**시키기 위해서이다

### HikariCP 동작 방식

**커넥션 얻기**
- 커넥션을 요청한 스레드가 이전에 사용한 커넥션이 커넥션 풀에 존재한다면 이를 반환한다
- 전체 커넥션 풀에서 사용 가능한 커넥션이 있는지 탐색, 존재하면 이를 반환한다
- 커넥션이 모두 사용 중이면 요청을 보낸 스레드는 다른 스레드가 사용중인 커넥션이 큐에 반환하기를 기다린다
- 대기하는 동안 다른 스레드에서 커넥션을 반환하면 해당 커넥션을 반환한다
- 지정된 타임아웃 시간동안 커넥션이 반환되지 않으면 예외를 던진다

**커넥션 반환하기**
- 스레드에서 `Connection.close()` 를 호출하여 커넥션 풀에 커넥션을 반환한다
- `HikariCP` 는 커넥션의 상태를 `IDLE` 로 변경한다
- 큐에 커넥션을 기다리는 스레드가 있다면 반환된 커넥션을 큐에 넣어준다

### 정리
커넥션 풀을 사용하는 이유와 `HikariCP` 가 커넥션을 제공하고 반환받는 과정을 추상적으로 알아보았다.
지금까지 학습한 내용만으로는 커넥션 풀 크기 이상의 요청이 왔을 때, 스레드가 큐에서 대기를 하는건지 잘 모르겠다.

다음 `TIL` 에서는 이를 코드 레벨에서 자세히 알아보도록 하겠다.

### 참고자료 & 추후 읽어볼 자료
- https://techblog.woowahan.com/2664/
- https://kakaocommerce.tistory.com/45
- https://steady-coding.tistory.com/564
- https://devkly.com/db/db-connection-pool/

