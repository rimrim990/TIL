# TIL - 2023.09.09 (ν† )
## AOP

μ—°μ–΄ν λ¨Ήκ³  μ‹¶λ‹¤ π£

### Java Reflection
μλ°” λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•μ—¬ λ°νƒ€μ„μ— ν΄λμ¤ μ •λ³΄λ¥Ό κ°€μ Έμ™€ μ΅°μ‘ν•  μ μλ‹¤.
```java
Class class = Class.forName("test");
Method methods[] = class.getDeclaredMethods();
```
- ν΄λμ¤ μ΄λ¦„μ— ν•΄λ‹Ήν•λ” ν΄λμ¤λ¥Ό λ΅λ”©ν•  μ μλ‹¤
- ν΄λμ¤μ— μ •μλ λ©”μ„λ“ μ •λ³΄λ¥Ό κ°€μ Έμ¬ μ μλ‹¤
  - `Method`λ” λ©”μ„λ“μ λ©”νƒ€λ°μ΄ν„°λ¥Ό λ‚νƒ€λ‚΄λ” ν΄λμ¤

```java
Class cls = Class.forName("test");

// μƒμ„±μ κ°€μ Έμ¤κΈ°
Constructor ct = cls.getConstructor(partypes);
Object retobj = ct.newInstance(arglist);

// ν•„λ“ κ°€μ Έμ¤κΈ°
Field fld = cls.getField("testField");
```
- ν•„λ“ κ°’μ„ μ΅°μ‘ν•κ±°λ‚ μƒμ„±μλ¥Ό κ°€μ Έμ™€ μƒλ΅μ΄ κ°μ²΄ μƒμ„±μ΄ κ°€λ¥ν•λ‹¤
- λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•λ©΄ μ ‘κ·Ό μ μ–΄μ λ λ²¨κ³Ό κ΄€κ³„μ—†μ΄ ν•„λ“λ‚ λ©”μ„λ“μ— μ ‘κ·Ό κ°€λ¥ν•λ‹¤

### ν”„λ΅μ‹
μ„λΉ„μ¤μ— λΉ„μ¦λ‹μ¤ λ΅μ§μ„ κµ¬ν„ν•΄μ•Ό ν•λ”λ°, ν•΄λ‹Ή λ΅μ§μ—μ„λ” νΈλμ­μ…μ΄ ν•„μ”ν•λ‹¤κ³  κ°€μ •ν•μ
- λΉ„μ¦λ‹μ¤ λ΅μ§ μ‹μ‘ μ „μ— νΈλμ­μ…μ„ μ‹μ‘ν•κ³ , λΉ„μ¦λ‹μ¤ λ΅μ§μ΄ μΆ…λ£ν•λ©΄ νΈλμ­μ…μ„ μ»¤λ°‹ν•κ±°λ‚ λ΅¤λ°±ν•΄μ•Ό ν•¨
- μ΄λ¥Ό ν•λ‚μ λ©”μ„λ“μ— κµ¬ν„ν•λ©΄ νΈλμ­μ… μ²λ¦¬λ¥Ό μ„ν• λ¶€κ°€ κΈ°λ¥κ³Ό λΉ„μ¦λ‹μ¤ λ΅μ§μ΄ μ„μ—¬ λ©”μ„λ“κ°€ λΉ„λ€ν•΄μ§
```java
tx.begin();
logic();
tx.commit();
```

νΈλμ­μ… λ¶€κ°€λ΅μ§κ³Ό μ„λΉ„μ¤ λ΅μ§μ„ DI λ΅ λ¶„λ¦¬ν•  μ μλ‹¤
- μ„λΉ„μ¤ λ΅μ§μ„ μ„ν• μΈν„°νμ΄μ¤ μƒμ„±
- ν•΄λ‹Ή μΈν„°νμ΄μ¤μ κµ¬ν„μ²΄μ— λΉ„μ¦λ‹μ¤ λ΅μ§ κµ¬ν„
- μ„λΉ„μ¤ μΈν„°νμ΄μ¤ κµ¬ν„μ²΄λ¥Ό μƒλ΅ μƒμ„±, νΈλμ­μ… μ²λ¦¬ν•κ³  μ‹¤μ  λ΅μ§μ„ λΉ„μ¦λ‹μ¤ λ΅μ§ κµ¬ν„μ²΄μ— μ„μ„
```java
// μΈν„°νμ΄μ¤ 
public interface Service() {
    public void logic();
}

// λΉ„μ¦λ‹μ¤ λ΅μ§ κµ¬ν„
public class ServiceImpl() implements Service {
    public void logic();
}

// νΈλμ­μ… λ¶€κ°€ λ΅μ§
public class ServiceTx() implements Service {
    // λ΅μ§ μ„μ„μ„ μ„ν•΄ ν•„λ“λ΅ μ„ μ–Έ
  private Service serviceImpl;
  
  public void logic() {
      tx.begin();
      serviceImpl.logic();
      tx.commit();
  }
}
```
- μ‚¬μ©μλ” μ„λΉ„μ¤ μΈν„°νμ΄μ¤λ¥Ό μ£Όμ…λ°›λ„λ΅ ν•μ—¬, νΈλμ­μ… λ¶€κ°€ κΈ°λ¥μ„ μ•μ§€ λ»ν•κ² μ¶”μƒν™”ν•λ‹¤
- μ΄μ²λΌ **μ‹¤μ  λ€μƒμΈ κ²ƒμ²λΌ μ„μ¥**ν•΄μ„ **ν΄λΌμ΄μ–ΈνΈμ μ”μ²­μ„ λ°›μ•„μ£Όλ” κ²ƒ**μ„ `ν”„λ΅μ‹`λΌκ³  ν•λ‹¤
- ν”„λ΅μ‹μ—μ„ μ”μ²­μ„ μ„μ„λ°›μ•„ μ‹¤μ§μ μΌλ΅ νΈμ¶ν•λ” κ°μ²΄λ¥Ό **νƒ€κΉƒ**μ΄λΌκ³  ν•λ‹¤

### λ‹¤μ΄λ‚΄λ―Ή ν”„λ΅μ‹
μΈν„°νμ΄μ¤μ— λ©”μ„λ“κ°€ λ§μ•„μ§€λ©΄ μ΄λ¥Ό μ „λ¶€ κµ¬ν„ν•κ³  μ„μ„ν•λ” ν”„λ΅μ‹ κ°μ²΄λ¥Ό μƒμ„±ν•κΈ° λ²κ±°λ΅μ›μ§„λ‹¤.

μλ°”μ—μ„λ” μ΄λ¥Ό μ‰½κ² κµ¬ν„ν•  μ μλ” λ‹¤μ΄λ‚΄λ―Ή ν”„λ΅μ‹ κΈ°λ¥μ„ μ κ³µν•λ‹¤.

```java
public class Handler implements InvocationHandler {

    // λ©”μ„λ“ νΈμ¶μ„ μ„μ„ν•κΈ° μ„ν•΄ νƒ€κΉƒ μ¤λΈμ νΈλ¥Ό ν•„λ“λ΅ μ„ μ–Έ
    private final Object target;

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // νƒ€κΉƒμΌλ΅ μ„μ„
        Object result = method.invoke(target, args);
        // λ¶€κ°€ κΈ°λ¥ κµ¬ν„
        ...
        return result;
    }
}
```
- `Method`λ” λ¦¬ν”λ ‰μ…μΌλ΅ κ°€μ Έμ¨ νƒ€κΉƒμ λ©”μ„λ“μ΄λ‹¤
- `method.invoke`λ΅ νƒ€κΉƒμ λ©”μ„λ“λ¥Ό νΈμ¶ν•κ³ , νΈμ¶ μ „ ν›„λ΅ λ¶€κ°€ κΈ°λ¥μ„ κµ¬ν„ν•λ‹¤

```java
final Hello helloProxy = (Hello) Proxy.newProxyInstance(
        getClass().getClassLoader(),
        new Class[] { Hello.class },
        upperCaseHandler
);
```
- μƒμ„±λ ν”„λ΅μ‹λ” μΈμλ΅ λ„κ²¨μ§„ `Hello.class`λ¥Ό κµ¬ν„ν•λ‹¤
- ν”„λ΅μ‹μ λ¨λ“  λ©”μ„λ“λ” νΈμ¶λλ©΄ μ•μ„ μ •μν• ν•Έλ“¤λ¬μ `invoke`λ΅ νΈμ¶μ΄ λ„μ–΄κ°„λ‹¤
- λ”°λΌμ„ ν΄λμ¤μ λ¨λ“  λ©”μ„λ“μ— κ³µν†µμ μΌλ΅ μ μ©ν•  μ μλ” λ¶€κ°€ κΈ°λ¥μ„ μ •μν•  μ μλ‹¤

### μ¤ν”„λ§ ν”„λ΅μ‹
μλ°”μ—μ„ μ κ³µν•λ” λ‹¤μ΄λ‚΄λ―Ή ν”„λ΅μ‹ μ™Έμ—λ„, μ¤ν”„λ§μ—μ„ μ κ³µν•λ” `ProxyFactoryBean`μ„ μ‚¬μ©ν•μ—¬ ν”„λ΅μ‹λ¥Ό μƒμ„±ν•κ³  λΉμΌλ΅ λ“±λ΅ κ°€λ¥ν•λ‹¤

**μ–΄λ“λ°”μ΄μ¤**
```java
public class Advice implements MethodInterceptor {

    @Override
    public Object invoke(MethodInvocation invocation) throws Throwable {
        // μ‹¤μ  λ©”μ„λ“ νΈμ¶
        final Object result = invocation.proceed();
        ...
        // λ¶€κ°€κΈ°λ¥
        return result;
    }
}
```
- ν”„λ΅μ‹ ν©ν† λ¦¬ λΉλ„ λ‹¤μ΄λ‚΄λ―Ή ν”„λ΅μ‹μ™€ μ μ‚¬ν• λ°©μ‹μΌλ΅ μ‚¬μ©ν•  μ μλ‹¤
- `invocation.proceed`λ΅ νƒ€κΉƒμ μ‹¤μ  λ©”μ„λ“λ¥Ό νΈμ¶ν•λ‹¤
- μ¤ν”„λ§ ν”„λ΅μ‹μ—μ„λ” λ¶€κ°€ κΈ°λ¥ μ²λ¦¬λ¥Ό μ„ν• μ„μ™€ κ°™μ€ κ°μ²΄λ¥Ό **μ–΄λ“λ°”μ΄μ¤**λΌκ³  ν•λ‹¤

```java
final ProxyFactoryBean pfBean = new ProxyFactoryBean();
pfBean.setTarget(helloTarget);
pfBean.addAdvice(upperCaseAdvice);

final Hello helloProxy = (Hello) pfBean.getObject();
```
- ν”„λ΅μ‹ ν©ν† λ¦¬ λΉμ„ μ‚¬μ©ν•μ—¬ νƒ€κΉƒκ³Ό λ™μΌν• μΈν„°νμ΄μ¤λ¥Ό μƒμ†λ°›λ” ν”„λ΅μ‹ μƒμ„±μ΄ κ°€λ¥ν•λ‹¤

**ν¬μΈνΈ μ»·**
```java
// sayH λ΅ μ‹μ‘ν•λ” λ©”μ„λ“λ§ μ‹¤ν–‰ λ€μƒμΌλ΅ μ„ μ •ν•λ” ν¬μΈνΈ μ»·
final NameMatchMethodPointcut pointcut = new NameMatchMethodPointcut();
pointcut.setMappedName("sayH*");
```
- νΉμ • ν¨ν„΄κ³Ό μΌμΉν•λ” λ©”μ„λ“λ§ ν”„λ΅μ‹ λ¶€κ°€κΈ°λ¥μ΄ νΈμ¶λλ„λ΅ μ„¤μ •ν•  μ μλ‹¤
- μ΄μ™€ κ°™μ€ λ©”μ„λ“ μ„ μ • μ•κ³ λ¦¬μ¦μ„ λ‹΄μ€ κ°μ²΄λ¥Ό **ν¬μΈνΈ μ»·**μ΄λΌκ³  ν•λ‹¤

**μ–΄λ“λ°”μ΄μ €**
```java
pfBean.addAdvisor(new DefaultPointcutAdvisor(pointcut, upperCaseAdvice));
```
- ν¬μΈνΈ μ»·κ³Ό μ–΄λ“λ°”μ΄μ¤λ¥Ό λ¬¶μ–΄μ„ μ–΄λ“λ°”μ΄μ € κ°μ²΄λ΅ κ΄€λ¦¬ν•λ‹¤