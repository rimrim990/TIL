# TIL - 2023.09.08 (ê¸ˆ)
## íŠ¸ëœì­ì…˜ ì „íŒŒ ì†ì„± - ë½, ì»¤ë„¥ì…˜

ì¡¸ë¦¬ë‹¤ ğŸ¥²

ì—¬í–‰ê°€ê³  ì‹¶ë‹¤ ğŸ”¥

### ì„œë¬¸
íŠ¸ëœì­ì…˜ ì „íŒŒ ì†ì„±ì„ ë³µìŠµí•˜ë‹¤ê°€ ê¶ê¸ˆì¦ì´ ìƒê²¼ë‹¤.
íŠ¸ëœì­ì…˜ì´ ì¤‘ì²©ë˜ì–´ì„œ ìƒì„±ë  ë•Œ, ë½ê³¼ DB ì»¤ë„¥ì…˜ì€ ì–¸ì œ í•´ì œë˜ê³  ìƒì„±ë ê¹Œ ?
ë½ì´ë‚˜ ì»¤ë„¥ì…˜ ìœ ì§€ ì‹œê°„ë„ ì „íŒŒ ì†ì„±ì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ”ì§€ ì˜ë¬¸ì´ ìƒê²¨ì„œ ì´ì— ëŒ€í•´ ì•Œì•„ë³´ë„ë¡ í•˜ê² ë‹¤.

### JDBC ì»¤ë„¥ì…˜ í…ŒìŠ¤íŠ¸

í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ë‹¤ìŒê³¼ ê°™ë‹¤
- `Service` ê³„ì¸µì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤
- `Service` ê³„ì¸µì—ì„œ `Repository` ë¥¼ í˜¸ì¶œí•˜ì—¬ íŠ¸ëœì­ì…˜ì´ ì¤‘ì²©ëœë‹¤

**REQUIRED**
```
Creating new transaction with name [getWithTransaction]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
Opened new EntityManager [SessionImpl(2105051301<open>)] for JPA transaction
Exposing JPA transaction as JDBC [HibernateJpaDialect$HibernateConnectionHandle@7fd7085d]
Getting transaction for [learn.java.testrepository.jpa.transaction.CarService.getWithTransaction]
```
- `@Transaction` ì´ ì„¤ì •ëœ `Service` ë©”ì„œë“œ ì‹¤í–‰ì— ì˜í•´ íŠ¸ëœì­ì…˜ì´ ìƒˆë¡œ ì‹œì‘ëœë‹¤
- ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë¨ì— ë”°ë¼ `EntityManager`ë¥¼ ìƒˆë¡œ ìƒì„±í•œë‹¤

```
Found thread-bound EntityManager [SessionImpl(2105051301<open>)] for JPA transaction
Participating in existing transaction
Getting transaction for [CarRepository.findByWithSameTransaction]
Completing transaction for [CarRepository.findByWithSameTransaction]
```
- `REQUIRED` ì „íŒŒ ì†ì„±ì´ ì„¤ì •ëœ `Repository` ë©”ì„œë“œê°€ ì‹¤í–‰ëœë‹¤
- `Service`ê³„ì¸µì—ì„œ ìƒì„±í•œ íŠ¸ëœì­ì…˜ì´ ì¡´ì¬í•˜ë¯€ë¡œ, ì—¬ê¸°ì— ì°¸ì—¬í•œë‹¤
- `Repository` íŠ¸ëœì­ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì»¤ë°‹ëœë‹¤

```
Completing transaction for [CarService.getWithTransaction]
Initiating transaction commit
Committing JPA transaction on EntityManager [SessionImpl(2105051301<open>)]
Closing JPA EntityManager [SessionImpl(2105051301<open>)] after transaction
```
- `Service` ë©”ì„œë“œê°€ ì¢…ë£Œë˜ê³  íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤
- íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ë©´ì„œ `EntityManager` ê°€ ì¢…ë£Œëœë‹¤

**REQUIRES_NEW**
```
Creating new transaction with name [getWithTransaction]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
Opened new EntityManager [SessionImpl(1842201464<open>)] for JPA transaction
Exposing JPA transaction as JDBC [HibernateJpaDialect$HibernateConnectionHandle@69cc3370]
Getting transaction for [learn.java.testrepository.jpa.transaction.CarService.getWithTransaction]
```
- `@Transaction` ì´ ì„¤ì •ëœ `Service` ë©”ì„œë“œ ì‹¤í–‰ì— ì˜í•´ íŠ¸ëœì­ì…˜ì´ ìƒˆë¡œ ì‹œì‘ëœë‹¤
- ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë¨ì— ë”°ë¼ `EntityManager`ë¥¼ ìƒˆë¡œ ìƒì„±í•œë‹¤

```
Found thread-bound EntityManager [SessionImpl(2105051301<open>)] for JPA transaction
Suspending current transaction, creating new transaction with name [CarRepository.findByWithNewTransaction]
Opened new EntityManager [SessionImpl(1520596362<open>)] for JPA transaction
Exposing JPA transaction as JDBC [HibernateJpaDialect$HibernateConnectionHandle@1a916120]
Getting transaction for [CarRepository.findByWithNewTransaction]
```
- `REQUIRES_NEW` ì „íŒŒ ì†ì„±ì´ ì„¤ì •ëœ `Repository` ë©”ì„œë“œê°€ ì‹¤í–‰ëœë‹¤
- ê¸°ì¡´ì— ì‹¤í–‰ë˜ë©´ `Service` ê³„ì¸µ íŠ¸ëœì­ì…˜ì„ ì¤‘ë‹¨í•˜ê³  ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ìƒì„±í•œë‹¤
- ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë¨ì— ë”°ë¼ `EntityManager`ë¥¼ ìƒˆë¡œ ìƒì„±í•œë‹¤

```java
Completing transaction for [CarRepository.findByWithNewTransaction]
Initiating transaction commit
Committing JPA transaction on EntityManager [SessionImpl(1520596362<open>)]
Closing JPA EntityManager [SessionImpl(1520596362<open>)] after transaction
```
- `Repository` ë©”ì„œë“œê°€ ì¢…ë£Œë˜ê³  íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤
- íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ë©´ì„œ `EntityManager` ê°€ ì¢…ë£Œëœë‹¤

```
Resuming suspended transaction after completion of inner transaction
Completing transaction for [CarService.getWithTransaction]
Initiating transaction commit
Committing JPA transaction on EntityManager [SessionImpl(1842201464<open>)]
Closing JPA EntityManager [SessionImpl(1842201464<open>)] after transaction
```
- `Repository` ê³„ì¸µ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ë©´ì„œ ì¤‘ë‹¨ë˜ì—ˆë˜ `Service` ê³„ì¸µ íŠ¸ëœì­ì…˜ì´ ë‹¤ì‹œ ì‹œì‘ëœ
- `Service` ë©”ì„œë“œê°€ ì¢…ë£Œë˜ê³  íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤
- íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ë©´ì„œ `EntityManager` ê°€ ì¢…ë£Œëœë‹¤

**ì»¤ë„¥ì…˜ ë¡œê·¸**
- `Service` ì™€ `Repository` ê³„ì¸µì— `Connection` ë©”íƒ€ë°ì´í„°ë¥¼ ì¶œë ¥í•´ë³´ì•˜ë‹¤
```java
// REQUIRED
conn1: url=jdbc:h2:mem:61788cb5
conn2: url=jdbc:h2:mem:61788cb5

// REQUIRES_NEW
conn1: url=jdbc:h2:mem:f27098d3
conn3: url=jdbc:h2:mem:f27098d3
```
- ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ëª¨ë“  íŠ¸ëœì­ì…˜ë§ˆë‹¤ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì´ ìƒì„±ë˜ì—ˆë‹¤

**ì •ë¦¬**
- `EntityManager`ì˜ ê¸°ë³¸ íƒ€ì…ì€ `TRANSACTION`ì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ê³¼ ë™ì¼í•œ ë¼ì´í”„ ì‚¬ì´í´ì„ ê°–ëŠ”ë‹¤
- `REQUIRED`ì „íŒŒ ì†ì„±ì—ì„œëŠ” í•˜ë‚˜ì˜ ë¬¼ë¦¬ì  íŠ¸ëœì­ì…˜ë§Œ ìƒì„±ë˜ë¯€ë¡œ í•˜ë‚˜ì˜ `EntityManager`ê°€ ìƒì„±ë˜ê³  ì´ë¥¼ ê³µìœ í•œë‹¤
- `REQUIRES_NEW`ì „íŒŒ ì†ì„±ì—ì„œëŠ” ìƒˆë¡œìš´ ë¬¼ë¦¬ì  íŠ¸ëœì­ì…˜ì´ ìƒì„±ë˜ë¯€ë¡œ ë…ë¦½ì ì¸ `EntityManager`ê°€ ìƒì„±ëœë‹¤
- ê·¸ëŸ¬ë‚˜ JDBC ì»¤ë„¥ì…˜ì€ ì „íŒŒ ì†ì„±ê³¼ ìƒê´€ì—†ì´ ëª¨ë“  ë…¼ë¦¬ì  íŠ¸ëœì­ì…˜ì´ ë…ë¦½ì ìœ¼ë¡œ ìœ ì§€í•œë‹¤

### lock í…ŒìŠ¤íŠ¸
ìë™í™”ëœ í…ŒìŠ¤íŠ¸ ë°©ë²•ì´ ìƒê°ë‚˜ì§€ ì•Šì•„ `h2-console`ê³¼ `api` ë¥¼ ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ë‹¤ 

í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ë‹¤ìŒê³¼ ê°™ë‹¤
- `Service` ê³„ì¸µì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤
- `Service` ê³„ì¸µì—ì„œ `Repository` ë¥¼ í˜¸ì¶œí•˜ì—¬ íŠ¸ëœì­ì…˜ì´ ì¤‘ì²©ëœë‹¤
- `Repository`ì—ì„œ ë¹„ê´€ì  ë½ì„ ê±¸ì–´ ì¡°íšŒí•œ í›„, 5ì´ˆê°„ `Thread.sleep`í•œë‹¤
- `Service`ëŠ” `Repository` ë©”ì„œë“œ í˜¸ì¶œì´ ì¢…ë£Œë˜ë©´ 5ì´ˆê°„ `Thread.sleep`í•œë‹¤
- `Service` ìŠ¤ë ˆë“œê°€ ì ë“¤ì–´ìˆëŠ” ë™ì•ˆ `update` sql ì„ ì‹¤í–‰í•œë‹¤

**REQUIRED**
- `Service`ê³„ì¸µ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œê¹Œì§€ `update`ê°€ ë¸”ë½ëœë‹¤

**REQUIRES_NEW**
- `Repository`ê³„ì¸µ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ë©´ ë½ì„ í•´ì œí•œë‹¤
- `Service`ê³„ì¸µì´ `Thread.sleep`í•˜ëŠ” ë™ì•ˆ `update`ê°€ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤

**ì •ë¦¬**
- ì»¤ë„¥ì…˜ê³¼ ë‹¬ë¦¬ ë½ì€ ë…¼ë¦¬ì  ìŠ¤ë ˆë“œê°€ ì¡ê³ ìˆë‹¤
- `REQUIRED`ì „íŒŒ ì†ì„±ì—ì„œëŠ” ìµœìƒë‹¨ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ê¸° ì „ê¹Œì§€ ë‚´ë¶€ íŠ¸ëœì­ì…˜ì—ì„œ ê±¸ì—ˆë˜ ë½ì„ ìœ ì§€í•œë‹¤
- `REQUIRES_NEW`ì „íŒŒ ì†ì„±ì—ì„œëŠ” ë‚´ë¶€ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ìˆœê°„ ë°”ë¡œ ë½ì„ í•´ì œí•œë‹¤

**ì‹¤ìŠµì½”ë“œ**
https://github.com/rimrim990/test-repository/blob/main/src/main/java/learn/java/testrepository/jpa/transaction/CarRepository.java

