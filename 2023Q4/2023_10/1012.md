# TIL - 2023.10.12(목)
## 도커 컨테이너

### 서문
도커 컨테이너.. 어렵다.. 가상 머신이랑 다르다는 것은 알고 있는데 뭐가 어떻게 다르다는 걸까

### 컨테이너가 무엇일까?
**컨테이너**

컨테이너는 호스트 머신에서 실행되는 다른 프로세스들과 격리된 환경에서 실행되는 프로세스이다. 컨테이너 격리를 위해 리눅스의 `kernel namespaces` 와 `cgroups` 가 사용된다
- 도커 컨테이너는 이미지를 실행한 인스턴스이다. 도커 API 를 사용하여 컨테이너의 생성, 중지, 삭제가 가능하다
- 도커 컨테이너는 어떤 OS 환경에서든 실행 가능하다
- 도커 컨테이너는 다른 컨테이너와 격리된 환경에서 수행된다

도커 컨테이너는 단일 호스트 안에서 실행되는 **격리된 프로세스 그룹**에 불과하다
- 리눅스에서는 프로세스들을 트리 구조로 관리하기 때문에 컨테이너도 반드시 루트 프로세스를 갖고 있다

**이미지**

호스트 시스템에서 실행되는 도커 컨테이너는 고립된 파일시스템을 사용한다. 이러한 고립된 파일시스템은 컨테이너 이미지에 의해 제공된다
- 이미지는 의존성, 설정 정보, 스크립트 등 컨테이너 실행을 위한 모든 정보들을 담고 있다

### namespace
리눅스 네임스페이스는 그 안에 속하는 프로세스들이 고립된 자원들을 사용하는 것처럼 만들 수 있다
- 서로 다른 커널 네임스페이스에 속한 프로세스들은 시스템에 대해 서로 다른 시점을 보유하게 된다
- `mnt`, `pid`, `net`, `ipc`, `uts`, `user`, `cgroup` 등의 서로 다른 네임스페이스들이 존재한다

```
$ ls -al /proc/1/ns
total 0
dr-x--x--x 2 root root 0 Jan 31 03:47 .
dr-xr-xr-x 9 root root 0 Jan 24 14:46 ..
lrwxrwxrwx 1 root root 0 Jan 31 03:47 cgroup -> 'cgroup:[4026531835]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 ipc -> 'ipc:[4026531839]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 mnt -> 'mnt:[4026531840]'
lrwxrwxrwx 1 root root 0 Jan 31 03:47 net -> 'net:[4026531993]'
```
- `/proc/<PID>/ns` 디렉토리에서 현재 프로세스에서 사용하고 있는 네임스페이스의 ID 를 확인할 수 있다
- 프로세스에 할당된 리소스별로 네임스페이스가 존재한다
- 출력 결과에 존재하는 `4026531835`와 같은 값은 각 네임스페이스의 고유 아이디이다

```
$ ls -l /proc/1074/ns
total 0
lrwxrwxrwx 1 root root 0 Jan 31 04:08 cgroup -> 'cgroup:[4026531835]'
lrwxrwxrwx 1 root root 0 Jan 31 04:08 ipc -> 'ipc:[4026531839]'
lrwxrwxrwx 1 root root 0 Jan 31 04:08 mnt -> 'mnt:[4026531840]'
lrwxrwxrwx 1 root root 0 Jan 31 04:08 net -> 'net:[4026531993]'
```
- 리눅스에서는 1번 프로세스인 `init`에 할당된 네임스페이스들을 자식 프로세스들이 모두 공유해서 사용한다
- 자식 프로세스의 네임 스페이스를 확인해보니 `init` 프로세스와 동일했다

**pid 네임스페이스**
- 프로세스 ID 를 격리할 수 있는 네임스페이스이다
- 리눅스에서는 `init` 프로세스가 PID 1번을 할당받으며 그 외에 모든 프로세스는 항상 1보다 큰 PID 를 부여받는다
- PID 네임스페이스를 분리하면 다시 PID 1번부터 시작할 수 있다. 분리된 PID 네임스페이스의 프로세스는 네임스페이스의 PID 와 호스트 시스템 내에서의 PID 를 동시에 갖게 된다

<img width="500" src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V7cmO3r2-UN5OsCzrXtUxw.png">

- PID 는 중첩되어 생성할 수 있다
- 리눅스에서 고아 프로세스를 주기적으로 1번 프로세스의 자식으로 변경하는데, 호스트 1번이 아닌 프로세스가 속한 네임스페이스의 1번 프로세스의 자식으로 편입된다
- 네임스페이스의 1번 프로세스가 종료되면 네임스페이스에 속한 모든 프로세스들은 함께 종료된다

**net 네임스페이스**
- 네트워크 자원을 격리할 수 있는 네임스페이스이다
- 모든 네트워크 네임스페이스는 독자적인 사설 IP 주소, 라우팅 테이블, 소켓 등의 네트워크 자원들을 보유하고 있다
- 네트워크 네임스페이스를 분리하여 프로세스들에게 새로운 IP 를 부여하거나 네트워크 인터페이스를 추가하는 것이 가능하다

**cgroup 네임스페이스**
- `cgroup` 네임스페이스는 자원의 제한과 제어를 위해 사용된다. 예를 들어 `cgroup` 네임스페이스에 속한 프로세스들의 메모리 사용량을 제한할 수 있다
- `cgroup`의 메모리 제한을 초과한 프로세스들은 호스트 시스템의 안정성을 위해 종료된다

### 정리
- 도커 컨테이너는 호스트에서 실행되는 프로세스에 불과하다! 일반 프로세스들과 다른 점은 격리된 자원을 사용한다는 점이다.
- 리눅스의 네임스페이스를 사용하여 다른 네임스페이스와 격리된 자원 설정이 가능하며, `cgroup` 네임스페이스는 프로세스들의 자원 사용을 제한할 수도 있다.
- 

### 출처
- https://medium.com/@saschagrunert/demystifying-containers-part-i-kernel-space-2c53d6979504
- https://www.44bits.io/ko/keyword/linux-namespace#pid-%EB%84%A4%EC%9E%84%EC%8A%A4%ED%8E%98%EC%9D%B4%EC%8A%A4