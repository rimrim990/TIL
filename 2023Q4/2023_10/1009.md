# TIL - 2023.10.09(월)
## MySQL 서브쿼리

### 서문

<img width="800" alt="materialized" src="https://github.com/rimrim990/TIL/assets/62409503/d9274770-711c-43b3-b26a-ae3073aa9418">

MySQL 에서 서브쿼리의 실행계획을 확인해보니 `Materialized` 라는 방식이 사용되었음을 알게 되었다. 이게 무슨 방식일까?

### 서브쿼리 전략
MySQL 옵티마이저는 `IN` 과 `EXISTS` 같은 서브쿼리 처리를 위한 여러 가지 전략들을 갖고 있다. 그중 하나가 `Materialized` 방식이다

**Materialized**
- `Materialized` 방식은 서브 쿼리의 결과를 임시 테이블로 생성하여 메모리에 올려놓는 방식이다
- 서브쿼리 결과가 필요해진 시점에 MySQL 은 서브 쿼리를 실행해 결과로 임시 테이블을 생성한다
- 서브쿼리 결과가 다시 필요해지면 쿼리를 다시 실행하지 않고 메모리에 생성된 임시 테이블을 참조한다

**장점**
- `Materialized` 방식을 사용하면 아우터 쿼리의 로우 당 서브쿼리를 실행할 필요가 없다
- 서브쿼리는 임시 테이블 생성을 위해 단 한번만 실행된다

**다른방식은?**
- 그렇다면 MySQL 에서 사용하는 서브쿼리 실행 방식에 다른 것은 없나?
- `Materialized` 외에는 `SUBQUERY` 방식과 `DEPENDENT SUBQUERY` 방식이 존재한다
  - 해당 방식들은 아우터 테이블 로우 당 서브쿼리가 한 번씩 실행되었음을 의미

**실행계획 다시보기**

<img width="800" alt="materialized" src="https://github.com/rimrim990/TIL/assets/62409503/d9274770-711c-43b3-b26a-ae3073aa9418">

- 실행계획을 다시 살펴보니 서브쿼리를 먼저 실행한 후 임시 테이블인 `subquery2`를 생성하였다
- 이후 임시 테이블인 `subquery2`와 아우터 테이블인 `oi`와 조인을 수행하였다

**결론**
- MySQL 에서 사용하는 서브쿼리 최적화 방식인 `Materialized`는 서브쿼리를 수행 후 임시 테이블을 생성한다
- 생성된 임시 테이블을 아우터 테이블과 조인했기 때문에 서브쿼리를 여러 번 실행하지 않는다

**더 알아볼 것**
- 오늘 알아본 `Materialized` 외에도 다른 서브쿼리 최적화 전략에 대해 더 알아보자!
